{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE ScopedTypeVariables #-}

module Cardano.Tools.TestHelper where

import Cardano.Tools.DB (DB, DBTrace, withDB)
import Control.Exception (catch, onException, throwIO)
import Control.Monad.IO.Class (MonadIO, liftIO)
import Control.Tracer (Tracer)
import Data.String (IsString)
import GHC.IO.Exception (IOErrorType (UnsatisfiedConstraints), ioe_type)
import System.Directory (createDirectoryIfMissing, removePathForcibly)
import System.FilePath (takeDirectory, (</>))
import System.IO (BufferMode (..), Handle, IOMode (..), hPutStrLn, hSetBuffering, stderr, withFile)
import System.IO.Temp (createTempDirectory, getCanonicalTemporaryDirectory)
import System.Info (os)
import System.Posix (mkstemp)

-- | Create a unique directory in the caonical, system-specific temporary path,
-- e.g. in /tmp.
createTempDir :: (MonadIO m) => String -> m FilePath
createTempDir template = liftIO $ do
  tmpDir <- case os of
    "darwin" -> pure "/tmp"
    _ -> getCanonicalTemporaryDirectory
  createTempDirectory tmpDir template

-- | Create a temporary directory for the given 'action' to use. The directory
-- is removed if and only if the action completes successfuly.
withTempDir :: (MonadIO m) => String -> (FilePath -> m r) -> m r
withTempDir baseName action = do
  tmpDir <- createTempDir baseName
  res <- action tmpDir
  liftIO $ cleanup 0 tmpDir
  pure res
  where
    cleanup (maxAttempts :: Word) dir =
      removePathForcibly dir
        `catch` ( \e -> case ioe_type e of
                    UnsatisfiedConstraints ->
                      if maxAttempts < 3
                        then cleanup (succ maxAttempts) dir
                        else throwIO e
                    _ ->
                      throwIO e
                )

-- | Open given log file non-buffered in append mode and print a message with
-- filepath to @stderr@ on exceptions.
withLogFile :: FilePath -> (Handle -> IO a) -> IO a
withLogFile filepath io = do
  createDirectoryIfMissing True (takeDirectory filepath)
  withFile filepath AppendMode (\out -> hSetBuffering out NoBuffering >> io out)
    `onException` hPutStrLn stderr ("Logfile written to: " <> filepath)

createLog :: FilePath -> IO (FilePath, Handle)
createLog dir = mkstemp (dir </> "db-server.log")

withTestDB ::
  Tracer IO DBTrace ->
  (DB -> IO a) ->
  IO a
withTestDB = withDB testConfigFile testDatabaseDir

testConfigFile :: FilePath
testConfigFile = "test-data/config/config.json"

testDatabaseDir :: FilePath
testDatabaseDir = "test-data/test-db"

testHeaderHex :: (IsString a) => a
testHeaderHex = "828a0c1901275820e5b1b73c5e7ee253e87d02a420352b8f6250b76688acd06dc9a9b0f58532e1035820e41015edc7b39489226d27c51dbe84c636466b3e29758a95445297614a8050bf582006a90f0597762346dd9eee0017623aca4745105f75b6d0d44355b2639537293482584076b951f29f104902b0e3090cd36ae8ff73980e29e6ac7c770d4dfa309870b2510088f60943f9a5108b0eb438afc19ec4bed0a85a3dc612881cc3383e62f604255850f9b7d5afac819358cb68b1a4f941c8c77c43beb0fa697840ef3743b6059db749a7d8974693dafd67ce5ba4353bb0351d82a44cb77c875def59895709d59e3abd370dec6d85f14c4ab6a5e64d17e4fd0704582029571d16f081709b3c48651860077bebf9340abb3fc7133443c54f1f5a5edcf1845820a5ae7caf7a79b7f750d3d6da9a31d6523bdc0b99cc9dbfbdc11122e3ae07e8280000584071c1947b93fac5684a327a102f522d7b31daccfe8ef69ed0c36ed4618910245756bfe607b5a2bf7725045564b77ee18bfd7ed086b957d856a5491b51fbaedf06820a005901c01a462000cc7c061368fe46efb2974b74a390e9dc4ad5a243ff7f05d729b8bb6fd9177a2f9dd86f649bfed9eece9b83594253b6c705bacc1460fab79840907a05de8e5249591afc25d214c024eac3c1186c26136a8719ca647c3c554aff75301df40a7243f0cea69d0da41b0edd95c35cc6644a433e1a59898f70a88b9578635cb4ee2e7a940b2aa19d596f5b160abc0f83c66cd8c26d8f7226f4556d4a406e0b978df024d42a1a9236d58e8c64733aae1ee6e3258a27bfaf060b6c2913fc9bab1cb543b0b471a48af5e367b75d856a36f5899c8019f91d321c22d012ee466e509d49ca12ed800448ad43ee1575de56abad60d0cd1d2bb9b541573504040c3b4943c077e1127e25a0bb1fb8549c503b519f01f6092a3d3452341da2fb8687e07b340575532fe529cadd9701c300770930c4da09feed3a7f9b4d1253efe0fd1dc05e380763e756b7f6b04d45d45e61aba849736babb9224adbf27a8880f1ecc23dd0bbe61a5b73fa269cc100bf3f6cbd17163f31d38aa22db320d37cbb767821dee4500627980856833e796e4435768172cb98b8b33ed5970a92ab3f046050c9f5aeeafa151f9d11b93c425b68cace42f87c51dee5f0a38071b3a8da23743d699c"

testParentHash :: (IsString a) => a
testParentHash = "e5b1b73c5e7ee253e87d02a420352b8f6250b76688acd06dc9a9b0f58532e103"

testParentHex :: (IsString a) => a
testParentHex = "828a0b19010b5820c02836ece740e898371eec4b583dcbc62d1e6f6048fbab2b2538ed48fc7c798b5820e41015edc7b39489226d27c51dbe84c636466b3e29758a95445297614a8050bf582006a90f0597762346dd9eee0017623aca4745105f75b6d0d44355b26395372934825840ca4c710be92db163e35d48064ea0866d37772bec0026dfb68d5cbce7f8e738f36c8b033ca1e46a08607289fa0dd4cbca55cda6f696e4241c8b450a942c90ebc45850748daafccf0cad01f2245d858ff95998234fee511c6038f4edb1b0f894ec387e16eb6c36d8fd750c3caa71fd5657dae2c5a3a0c5d05ca6de78b0deb4d9235ad117b507f5867771add6546757114e1a0704582029571d16f081709b3c48651860077bebf9340abb3fc7133443c54f1f5a5edcf1845820a5ae7caf7a79b7f750d3d6da9a31d6523bdc0b99cc9dbfbdc11122e3ae07e8280000584071c1947b93fac5684a327a102f522d7b31daccfe8ef69ed0c36ed4618910245756bfe607b5a2bf7725045564b77ee18bfd7ed086b957d856a5491b51fbaedf06820a005901c0b84aeb1fc570ca478bb9aa51ca234be2b0ce19798d01f2e5e5e914ab4d80831f29687ebd441ce7a78a84904eb45ccbfa62143cf8e6905e89b9b289d0e9a2b509de8e5249591afc25d214c024eac3c1186c26136a8719ca647c3c554aff75301df40a7243f0cea69d0da41b0edd95c35cc6644a433e1a59898f70a88b9578635cb4ee2e7a940b2aa19d596f5b160abc0f83c66cd8c26d8f7226f4556d4a406e0b978df024d42a1a9236d58e8c64733aae1ee6e3258a27bfaf060b6c2913fc9bab1cb543b0b471a48af5e367b75d856a36f5899c8019f91d321c22d012ee466e509d49ca12ed800448ad43ee1575de56abad60d0cd1d2bb9b541573504040c3b4943c077e1127e25a0bb1fb8549c503b519f01f6092a3d3452341da2fb8687e07b340575532fe529cadd9701c300770930c4da09feed3a7f9b4d1253efe0fd1dc05e380763e756b7f6b04d45d45e61aba849736babb9224adbf27a8880f1ecc23dd0bbe61a5b73fa269cc100bf3f6cbd17163f31d38aa22db320d37cbb767821dee4500627980856833e796e4435768172cb98b8b33ed5970a92ab3f046050c9f5aeeafa151f9d11b93c425b68cace42f87c51dee5f0a38071b3a8da23743d699c"

testBlockHex :: (IsString a) => a
testBlockHex = "820685828a0c1901275820e5b1b73c5e7ee253e87d02a420352b8f6250b76688acd06dc9a9b0f58532e1035820e41015edc7b39489226d27c51dbe84c636466b3e29758a95445297614a8050bf582006a90f0597762346dd9eee0017623aca4745105f75b6d0d44355b2639537293482584076b951f29f104902b0e3090cd36ae8ff73980e29e6ac7c770d4dfa309870b2510088f60943f9a5108b0eb438afc19ec4bed0a85a3dc612881cc3383e62f604255850f9b7d5afac819358cb68b1a4f941c8c77c43beb0fa697840ef3743b6059db749a7d8974693dafd67ce5ba4353bb0351d82a44cb77c875def59895709d59e3abd370dec6d85f14c4ab6a5e64d17e4fd0704582029571d16f081709b3c48651860077bebf9340abb3fc7133443c54f1f5a5edcf1845820a5ae7caf7a79b7f750d3d6da9a31d6523bdc0b99cc9dbfbdc11122e3ae07e8280000584071c1947b93fac5684a327a102f522d7b31daccfe8ef69ed0c36ed4618910245756bfe607b5a2bf7725045564b77ee18bfd7ed086b957d856a5491b51fbaedf06820a005901c01a462000cc7c061368fe46efb2974b74a390e9dc4ad5a243ff7f05d729b8bb6fd9177a2f9dd86f649bfed9eece9b83594253b6c705bacc1460fab79840907a05de8e5249591afc25d214c024eac3c1186c26136a8719ca647c3c554aff75301df40a7243f0cea69d0da41b0edd95c35cc6644a433e1a59898f70a88b9578635cb4ee2e7a940b2aa19d596f5b160abc0f83c66cd8c26d8f7226f4556d4a406e0b978df024d42a1a9236d58e8c64733aae1ee6e3258a27bfaf060b6c2913fc9bab1cb543b0b471a48af5e367b75d856a36f5899c8019f91d321c22d012ee466e509d49ca12ed800448ad43ee1575de56abad60d0cd1d2bb9b541573504040c3b4943c077e1127e25a0bb1fb8549c503b519f01f6092a3d3452341da2fb8687e07b340575532fe529cadd9701c300770930c4da09feed3a7f9b4d1253efe0fd1dc05e380763e756b7f6b04d45d45e61aba849736babb9224adbf27a8880f1ecc23dd0bbe61a5b73fa269cc100bf3f6cbd17163f31d38aa22db320d37cbb767821dee4500627980856833e796e4435768172cb98b8b33ed5970a92ab3f046050c9f5aeeafa151f9d11b93c425b68cace42f87c51dee5f0a38071b3a8da23743d699c8080a080"

testSnapshot :: (IsString a, Monoid a) => a
testSnapshot =
  mconcat
    [ "8700a0a2581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad085113",
      "2e43883f1905fd581cd3e16257b8c608ec4b2cb89621d7ddb60fc08839c1",
      "b491a598615fb51905b48482001b000001d1a9458c20828383a0a00084a2",
      "581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f",
      "89581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e4388",
      "3f5820ee8fdadab21abed48fadee52492596841c561640920d1c022fa8ae",
      "51d206c7140000d81e820001581de022c700325ec932f59048a7258e89b5",
      "f166604f184e0809d16a495550d901028080f6581cd3e16257b8c608ec4b",
      "2cb89621d7ddb60fc08839c1b491a598615fb589581cd3e16257b8c608ec",
      "4b2cb89621d7ddb60fc08839c1b491a598615fb55820bbc57641002e501c",
      "f8bf98b776ba082c604e6af7c482f716934ed08d19c227330000d81e8200",
      "01581de03832f1051268ab7a7765142f21d695b7aaf40c576bf2d1a71894",
      "f0a4d901028080f6a0a0a08482a28200581c6b47a4e6e19ac5257fc97bd2",
      "20bd9ae368aa2d775d86315ab7ef058f8481820000d901028081581cd3e1",
      "6257b8c608ec4b2cb89621d7ddb60fc08839c1b491a598615fb580820058",
      "1cd1f6f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d1384",
      "81820000d901028081581c1dc0a846ec816bdcc5288c0b57871a0400e867",
      "28ad0851132e43883f80a0a0a084a0a0000086a582582006d355f9b6ef9d",
      "7d0134dc55d4c5873130c7f8d93ef6ddfe124144133f1038e30082583900",
      "32635dc627da054f2a9e99559c56e16b02cf5f9237ba586ee1e648336b47",
      "a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef058f1b00038d",
      "0a3a73f80082582017920b7f80d4f9b7280d1651a673c697b1ecb9fa0432",
      "6063aa8f1e15ea94048c0082581d602b43cb2b891e2dc9f5b07e051fb8d2",
      "21a4a88ca161d95e859aa9ad8a1b0000082f79cd90008258208d6e245854",
      "87e17b1945eb294aa66a5b9dd147e11aa6a40ad9e1af54703fb2a0008258",
      "2f82d818582583581c2e51d90585c03c10a5650397fa83e1068ef6d210b5",
      "09def42ee95180a10242182a001a36de915919753082582095e23efc5aa6",
      "27de1cbe56ff1d82a9c6f1c7e05b1486408f188627832a457fdf0082582f",
      "82d818582583581c30de70e2cf7392376fb1c7d084726256dbd6885767aa",
      "a1c52e4f38b1a10242182a001a89556e521a00041eb0825820c7f7a98f1f",
      "77646faf066d744d94524ee3698a883eff1605e55bcbdbfff00f59008258",
      "390064f4987ff07483636803f71f5f8442dad7f7fc46d83e2242d1548ad5",
      "d1f6f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d131b00",
      "038d0a3a73f800000085a0a09700001a0001400019400019044c1a00061a",
      "801a1dcd6500121832d81e82030ad81e820b191388d81e82011405000019",
      "10d6a1009f1a000302590001011a00060bc719026d00011a000249f01903",
      "e800011a000249f018201a0025cea81971f70419744d186419744d186419",
      "744d186419744d186419744d186419744d18641864186419744d18641a00",
      "0249f018201a000249f018201a000249f018201a000249f01903e800011a",
      "000249f018201a000249f01903e800081a000242201a00067e2318760001",
      "011a000249f01903e800081a000249f01a0001b79818f7011a000249f019",
      "2710011a0002155e19052e011903e81a000249f01903e8011a000249f018",
      "201a000249f018201a000249f0182001011a000249f0011a000249f0041a",
      "000194af18f8011a000194af18f8011a0002377c190556011a0002bdea19",
      "01f1011a000249f018201a000249f018201a000249f018201a000249f018",
      "201a000249f018201a000249f018201a000242201a00067e231876000101",
      "19f04c192bd200011a000249f018201a000242201a00067e231876000101",
      "1a000242201a00067e2318760001011a0025cea81971f704001a000141bb",
      "041a000249f019138800011a000249f018201a000302590001011a000249",
      "f018201a000249f018201a000249f018201a000249f018201a000249f018",
      "201a000249f018201a000249f018201a00330da70101ff82d81e82190241",
      "192710d81e821902d11a00989680821a00d59f801b00000002540be40082",
      "1a03567e001b00000009502f90001913881896039700001a000140001940",
      "0019044c1a00061a801a1dcd6500121832d81e82030ad81e820b191388d8",
      "1e8201140500001910d6a1009f1a000302590001011a00060bc719026d00",
      "011a000249f01903e800011a000249f018201a0025cea81971f70419744d",
      "186419744d186419744d186419744d186419744d186419744d1864186418",
      "6419744d18641a000249f018201a000249f018201a000249f018201a0002",
      "49f01903e800011a000249f018201a000249f01903e800081a000242201a",
      "00067e2318760001011a000249f01903e800081a000249f01a0001b79818",
      "f7011a000249f0192710011a0002155e19052e011903e81a000249f01903",
      "e8011a000249f018201a000249f018201a000249f0182001011a000249f0",
      "011a000249f0041a000194af18f8011a000194af18f8011a0002377c1905",
      "56011a0002bdea1901f1011a000249f018201a000249f018201a000249f0",
      "18201a000249f018201a000249f018201a000249f018201a000242201a00",
      "067e23187600010119f04c192bd200011a000249f018201a000242201a00",
      "067e2318760001011a000242201a00067e2318760001011a0025cea81971",
      "f704001a000141bb041a000249f019138800011a000249f018201a000302",
      "590001011a000249f018201a000249f018201a000249f018201a000249f0",
      "18201a000249f018201a000249f018201a000249f018201a00330da70101",
      "ff82d81e82190241192710d81e821902d11a00989680821a00d59f801b00",
      "000002540be400821a03567e001b00000009502f90001913881896038100",
      "82a28200581c6b47a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315a",
      "b7ef058f1b00038d0a3a73f8008200581cd1f6f71a04ca856cc569fd068b",
      "069a555999c4776ad50b4cdd049d131b00038d0a3a73f800a0008483a282",
      "00581c6b47a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef05",
      "8f1b00038d0a3a73f8008200581cd1f6f71a04ca856cc569fd068b069a55",
      "5999c4776ad50b4cdd049d131b00038d0a3a73f800a28200581c6b47a4e6",
      "e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef058f581cd3e16257",
      "b8c608ec4b2cb89621d7ddb60fc08839c1b491a598615fb58200581cd1f6",
      "f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d13581c1dc0",
      "a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883fa2581c1d",
      "c0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f89581c",
      "1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f5820",
      "ee8fdadab21abed48fadee52492596841c561640920d1c022fa8ae51d206",
      "c7140000d81e820001581de022c700325ec932f59048a7258e89b5f16660",
      "4f184e0809d16a495550d901028080f6581cd3e16257b8c608ec4b2cb896",
      "21d7ddb60fc08839c1b491a598615fb589581cd3e16257b8c608ec4b2cb8",
      "9621d7ddb60fc08839c1b491a598615fb55820bbc57641002e501cf8bf98",
      "b776ba082c604e6af7c482f716934ed08d19c227330000d81e820001581d",
      "e03832f1051268ab7a7765142f21d695b7aaf40c576bf2d1a71894f0a4d9",
      "01028080f683a0a0a083a0a0a00082a0008082a2581c1dc0a846ec816bdc",
      "c5288c0b57871a0400e86728ad0851132e43883f83d81e8201021b00038d",
      "0a3a73f8005820ee8fdadab21abed48fadee52492596841c561640920d1c",
      "022fa8ae51d206c714581cd3e16257b8c608ec4b2cb89621d7ddb60fc088",
      "39c1b491a598615fb583d81e8201021b00038d0a3a73f8005820bbc57641",
      "002e501cf8bf98b776ba082c604e6af7c482f716934ed08d19c227331b00",
      "071a1474e7f000f6"
    ]
