{-# LANGUAGE OverloadedStrings #-}
{-# LANGUAGE ScopedTypeVariables #-}

module Cardano.Tools.TestHelper where

import Cardano.Tools.DB (DB, DBTrace, withDB)
import Control.Exception (catch, onException, throwIO)
import Control.Monad.IO.Class (MonadIO, liftIO)
import Control.Tracer (Tracer)
import Data.String (IsString)
import GHC.IO.Exception (IOErrorType (UnsatisfiedConstraints), ioe_type)
import System.Directory (createDirectoryIfMissing, removePathForcibly)
import System.FilePath (takeDirectory, (</>))
import System.IO (BufferMode (..), Handle, IOMode (..), hPutStrLn, hSetBuffering, stderr, withFile)
import System.IO.Temp (createTempDirectory, getCanonicalTemporaryDirectory)
import System.Info (os)
import System.Posix (mkstemp)

-- | Create a unique directory in the caonical, system-specific temporary path,
-- e.g. in /tmp.
createTempDir :: (MonadIO m) => String -> m FilePath
createTempDir template = liftIO $ do
  tmpDir <- case os of
    "darwin" -> pure "/tmp"
    _ -> getCanonicalTemporaryDirectory
  createTempDirectory tmpDir template

-- | Create a temporary directory for the given 'action' to use. The directory
-- is removed if and only if the action completes successfuly.
withTempDir :: (MonadIO m) => String -> (FilePath -> m r) -> m r
withTempDir baseName action = do
  tmpDir <- createTempDir baseName
  res <- action tmpDir
  liftIO $ cleanup 0 tmpDir
  pure res
  where
    cleanup (maxAttempts :: Word) dir =
      removePathForcibly dir
        `catch` ( \e -> case ioe_type e of
                    UnsatisfiedConstraints ->
                      if maxAttempts < 3
                        then cleanup (succ maxAttempts) dir
                        else throwIO e
                    _ ->
                      throwIO e
                )

-- | Open given log file non-buffered in append mode and print a message with
-- filepath to @stderr@ on exceptions.
withLogFile :: FilePath -> (Handle -> IO a) -> IO a
withLogFile filepath io = do
  createDirectoryIfMissing True (takeDirectory filepath)
  withFile filepath AppendMode (\out -> hSetBuffering out NoBuffering >> io out)
    `onException` hPutStrLn stderr ("Logfile written to: " <> filepath)

createLog :: FilePath -> IO (FilePath, Handle)
createLog dir = mkstemp (dir </> "db-server.log")

withTestDB ::
  Tracer IO DBTrace ->
  (DB -> IO a) ->
  IO a
withTestDB = withDB testConfigFile testDatabaseDir

testConfigFile :: FilePath
testConfigFile = "test-data/10.5.1/configs/config.json"

testDatabaseDir :: FilePath
testDatabaseDir = "test-data/10.5.1/db"

testHeaderHex :: (IsString a, Monoid a) => a
testHeaderHex = mconcat
  ["828a03182d5820a4c4c779920e71061beb02e3401b7d60459c33b3822acc"
  ,"0c444521ad59ce991f58204931e9208611dd6963a365d83ad6ee155d8485"
  ,"f67a7a7d63555daf75a903c5f95820b0ba97f118ec4ccfebcb0990840b38"
  ,"c31bb44af33a4b37a090dab6893e932e1c82584085f5ec7a904e7e2752a3"
  ,"22b2fc0ed7b03d548fd78db6f2b751fdc520e1a9b6bc82fec075318d83fb"
  ,"dd61cd130e56df51200510c17aee73f2cc011e6426205d8e5850574979d5"
  ,"502f4a229b5067abde255b5acc8636dee040fdb7b250bf4b8bf4e3688b0e"
  ,"3c4179f1451be400a28ee09f878737bef063a877248a73686dcdf9e486d6"
  ,"223cfc611ffe84c3628fc5fba9f6200504582029571d16f081709b3c4865"
  ,"1860077bebf9340abb3fc7133443c54f1f5a5edcf18458209613895ed7da"
  ,"6805f79c1a0e8fd0dd5abb8dfb89480d05958d317645b00c579100005840"
  ,"bb69ecb6d4f60b2cfc59f008af03ea2b1b71cf08e947447f46064f29c086"
  ,"9c22d0ae8453ac8fff07f3735f096e17e8b1e8cd61b54f17b7185cfdd9db"
  ,"3ae52f01820c005901c01af6e56ebd8bd4935a37dd76952df544af4b385f"
  ,"2a2d57dddb23e78d55171a18c4e54c72433dd4054a9d7227942f8f1286d5"
  ,"33e51c7a9e1b50c5dc4f153f5e01adf2807d5978a388fdc65e754c7c2f93"
  ,"68f7e0ca09071d2314a97ffd7e3b8b2ec1eb112c1d23bf1eb477f2d9ad42"
  ,"eccf5fec55c5ed2ebb6a175eac5632563dffe465b128187740ebbdd98c2f"
  ,"21730bd45366c80712ebdbf269e9658cec01b8578f707868514edfe6ccbe"
  ,"d05f5ba77905d086585a8262bbdeb605fcfbd56cc2bbd5c331fc99d5b9c0"
  ,"5e6cf450b29d9799e4ca351e506d94defbcc78b56970fd3a03969f751c77"
  ,"0f78adb70dbbb6ee52d59ebe58b201c0ef932f3892b9846e3d0dac8c1156"
  ,"a03dc5fd3d249ae8b82b3e56b10e1b494d5dd6d6f5418bc8db94b44c246a"
  ,"9156c19a153a19072a6f685893316c9f7b734dcb5f42bd48dc57941c2f11"
  ,"600b217cc91cf904051a16bbd9604837ed3815507efcc86e40454e8f1bd1"
  ,"ff1efe46080c363a157f5219c2be539ae52fc74d0ef09aa34d9b7dfda699"
  ,"08c59053ebaa65598bda7f4cd73b231c6348d5df78e04e4604828b804ea0"
  ,"bae97c50ecee22812af25397713533c9eeed11fd48900e6b4fce4e2413e2"
  ,"99699c481326e315"
  ]

testParentHash :: (IsString a) => a
testParentHash = "a4c4c779920e71061beb02e3401b7d60459c33b3822acc0c444521ad59ce991f"

testParentHex :: (IsString a, Monoid a) => a
testParentHex = mconcat
  ["828a02182b5820a579f97e4ebf3717c114a12a2622bf83759176f546092d"
  ,"776fc01d73d0557b0558204931e9208611dd6963a365d83ad6ee155d8485"
  ,"f67a7a7d63555daf75a903c5f95820b0ba97f118ec4ccfebcb0990840b38"
  ,"c31bb44af33a4b37a090dab6893e932e1c825840cf9c0e5a01deddf425ae"
  ,"1af310a0089d1d61fb5cdd1978688540302d2e42b7377aacbe0860bb17b7"
  ,"7217742e6cd121377d533389a878e56a7473454466c04997585001713a7a"
  ,"60b2c1d450f1eaaa0d6c2789012b1a7a2033fa7cc89ba7365d37598b0c0a"
  ,"2718efdbd3b941cb41f9fa7da663e38ddf588b9b44022f2c84740af6f25b"
  ,"9d1180507366df4cd95ea5bc966e5b0304582029571d16f081709b3c4865"
  ,"1860077bebf9340abb3fc7133443c54f1f5a5edcf18458209613895ed7da"
  ,"6805f79c1a0e8fd0dd5abb8dfb89480d05958d317645b00c579100005840"
  ,"bb69ecb6d4f60b2cfc59f008af03ea2b1b71cf08e947447f46064f29c086"
  ,"9c22d0ae8453ac8fff07f3735f096e17e8b1e8cd61b54f17b7185cfdd9db"
  ,"3ae52f01820c005901c0f8d373907b33ebb3a28b5091c36fc07033933fce"
  ,"118bede1b8851a45a94ef818b2929c96af7a520d791b8b09b7fe7b615422"
  ,"5de3b208d19ec374980d0a4edc0badf2807d5978a388fdc65e754c7c2f93"
  ,"68f7e0ca09071d2314a97ffd7e3b8b2ec1eb112c1d23bf1eb477f2d9ad42"
  ,"eccf5fec55c5ed2ebb6a175eac5632563dffe465b128187740ebbdd98c2f"
  ,"21730bd45366c80712ebdbf269e9658cec01b8578f707868514edfe6ccbe"
  ,"d05f5ba77905d086585a8262bbdeb605fcfbd56cc2bbd5c331fc99d5b9c0"
  ,"5e6cf450b29d9799e4ca351e506d94defbcc78b56970fd3a03969f751c77"
  ,"0f78adb70dbbb6ee52d59ebe58b201c0ef932f3892b9846e3d0dac8c1156"
  ,"a03dc5fd3d249ae8b82b3e56b10e1b494d5dd6d6f5418bc8db94b44c246a"
  ,"9156c19a153a19072a6f685893316c9f7b734dcb5f42bd48dc57941c2f11"
  ,"600b217cc91cf904051a16bbd9604837ed3815507efcc86e40454e8f1bd1"
  ,"ff1efe46080c363a157f5219c2be539ae52fc74d0ef09aa34d9b7dfda699"
  ,"08c59053ebaa65598bda7f4cd73b231c6348d5df78e04e4604828b804ea0"
  ,"bae97c50ecee22812af25397713533c9eeed11fd48900e6b4fce4e2413e2"
  ,"99699c481326e315" 
  ]

testBlockHex :: (IsString a, Monoid a) => a
testBlockHex = mconcat
  ["820785828a03182d5820a4c4c779920e71061beb02e3401b7d60459c33b3"
  ,"822acc0c444521ad59ce991f58204931e9208611dd6963a365d83ad6ee15"
  ,"5d8485f67a7a7d63555daf75a903c5f95820b0ba97f118ec4ccfebcb0990"
  ,"840b38c31bb44af33a4b37a090dab6893e932e1c82584085f5ec7a904e7e"
  ,"2752a322b2fc0ed7b03d548fd78db6f2b751fdc520e1a9b6bc82fec07531"
  ,"8d83fbdd61cd130e56df51200510c17aee73f2cc011e6426205d8e585057"
  ,"4979d5502f4a229b5067abde255b5acc8636dee040fdb7b250bf4b8bf4e3"
  ,"688b0e3c4179f1451be400a28ee09f878737bef063a877248a73686dcdf9"
  ,"e486d6223cfc611ffe84c3628fc5fba9f6200504582029571d16f081709b"
  ,"3c48651860077bebf9340abb3fc7133443c54f1f5a5edcf1845820961389"
  ,"5ed7da6805f79c1a0e8fd0dd5abb8dfb89480d05958d317645b00c579100"
  ,"005840bb69ecb6d4f60b2cfc59f008af03ea2b1b71cf08e947447f46064f"
  ,"29c0869c22d0ae8453ac8fff07f3735f096e17e8b1e8cd61b54f17b7185c"
  ,"fdd9db3ae52f01820c005901c01af6e56ebd8bd4935a37dd76952df544af"
  ,"4b385f2a2d57dddb23e78d55171a18c4e54c72433dd4054a9d7227942f8f"
  ,"1286d533e51c7a9e1b50c5dc4f153f5e01adf2807d5978a388fdc65e754c"
  ,"7c2f9368f7e0ca09071d2314a97ffd7e3b8b2ec1eb112c1d23bf1eb477f2"
  ,"d9ad42eccf5fec55c5ed2ebb6a175eac5632563dffe465b128187740ebbd"
  ,"d98c2f21730bd45366c80712ebdbf269e9658cec01b8578f707868514edf"
  ,"e6ccbed05f5ba77905d086585a8262bbdeb605fcfbd56cc2bbd5c331fc99"
  ,"d5b9c05e6cf450b29d9799e4ca351e506d94defbcc78b56970fd3a03969f"
  ,"751c770f78adb70dbbb6ee52d59ebe58b201c0ef932f3892b9846e3d0dac"
  ,"8c1156a03dc5fd3d249ae8b82b3e56b10e1b494d5dd6d6f5418bc8db94b4"
  ,"4c246a9156c19a153a19072a6f685893316c9f7b734dcb5f42bd48dc5794"
  ,"1c2f11600b217cc91cf904051a16bbd9604837ed3815507efcc86e40454e"
  ,"8f1bd1ff1efe46080c363a157f5219c2be539ae52fc74d0ef09aa34d9b7d"
  ,"fda69908c59053ebaa65598bda7f4cd73b231c6348d5df78e04e4604828b"
  ,"804ea0bae97c50ecee22812af25397713533c9eeed11fd48900e6b4fce4e"
  ,"2413e299699c481326e3158080a080"
  ]
testSnapshot :: (IsString a, Monoid a) => a
testSnapshot =
  mconcat
    [ "8700a0a2581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad085113",
      "2e43883f1905fd581cd3e16257b8c608ec4b2cb89621d7ddb60fc08839c1",
      "b491a598615fb51905b48482001b000001d1a9458c20828383a0a00084a2",
      "581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f",
      "89581c1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e4388",
      "3f5820ee8fdadab21abed48fadee52492596841c561640920d1c022fa8ae",
      "51d206c7140000d81e820001581de022c700325ec932f59048a7258e89b5",
      "f166604f184e0809d16a495550d901028080f6581cd3e16257b8c608ec4b",
      "2cb89621d7ddb60fc08839c1b491a598615fb589581cd3e16257b8c608ec",
      "4b2cb89621d7ddb60fc08839c1b491a598615fb55820bbc57641002e501c",
      "f8bf98b776ba082c604e6af7c482f716934ed08d19c227330000d81e8200",
      "01581de03832f1051268ab7a7765142f21d695b7aaf40c576bf2d1a71894",
      "f0a4d901028080f6a0a0a08482a28200581c6b47a4e6e19ac5257fc97bd2",
      "20bd9ae368aa2d775d86315ab7ef058f8481820000d901028081581cd3e1",
      "6257b8c608ec4b2cb89621d7ddb60fc08839c1b491a598615fb580820058",
      "1cd1f6f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d1384",
      "81820000d901028081581c1dc0a846ec816bdcc5288c0b57871a0400e867",
      "28ad0851132e43883f80a0a0a084a0a0000086a582582006d355f9b6ef9d",
      "7d0134dc55d4c5873130c7f8d93ef6ddfe124144133f1038e30082583900",
      "32635dc627da054f2a9e99559c56e16b02cf5f9237ba586ee1e648336b47",
      "a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef058f1b00038d",
      "0a3a73f80082582017920b7f80d4f9b7280d1651a673c697b1ecb9fa0432",
      "6063aa8f1e15ea94048c0082581d602b43cb2b891e2dc9f5b07e051fb8d2",
      "21a4a88ca161d95e859aa9ad8a1b0000082f79cd90008258208d6e245854",
      "87e17b1945eb294aa66a5b9dd147e11aa6a40ad9e1af54703fb2a0008258",
      "2f82d818582583581c2e51d90585c03c10a5650397fa83e1068ef6d210b5",
      "09def42ee95180a10242182a001a36de915919753082582095e23efc5aa6",
      "27de1cbe56ff1d82a9c6f1c7e05b1486408f188627832a457fdf0082582f",
      "82d818582583581c30de70e2cf7392376fb1c7d084726256dbd6885767aa",
      "a1c52e4f38b1a10242182a001a89556e521a00041eb0825820c7f7a98f1f",
      "77646faf066d744d94524ee3698a883eff1605e55bcbdbfff00f59008258",
      "390064f4987ff07483636803f71f5f8442dad7f7fc46d83e2242d1548ad5",
      "d1f6f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d131b00",
      "038d0a3a73f800000085a0a09700001a0001400019400019044c1a00061a",
      "801a1dcd6500121832d81e82030ad81e820b191388d81e82011405000019",
      "10d6a1009f1a000302590001011a00060bc719026d00011a000249f01903",
      "e800011a000249f018201a0025cea81971f70419744d186419744d186419",
      "744d186419744d186419744d186419744d18641864186419744d18641a00",
      "0249f018201a000249f018201a000249f018201a000249f01903e800011a",
      "000249f018201a000249f01903e800081a000242201a00067e2318760001",
      "011a000249f01903e800081a000249f01a0001b79818f7011a000249f019",
      "2710011a0002155e19052e011903e81a000249f01903e8011a000249f018",
      "201a000249f018201a000249f0182001011a000249f0011a000249f0041a",
      "000194af18f8011a000194af18f8011a0002377c190556011a0002bdea19",
      "01f1011a000249f018201a000249f018201a000249f018201a000249f018",
      "201a000249f018201a000249f018201a000242201a00067e231876000101",
      "19f04c192bd200011a000249f018201a000242201a00067e231876000101",
      "1a000242201a00067e2318760001011a0025cea81971f704001a000141bb",
      "041a000249f019138800011a000249f018201a000302590001011a000249",
      "f018201a000249f018201a000249f018201a000249f018201a000249f018",
      "201a000249f018201a000249f018201a00330da70101ff82d81e82190241",
      "192710d81e821902d11a00989680821a00d59f801b00000002540be40082",
      "1a03567e001b00000009502f90001913881896039700001a000140001940",
      "0019044c1a00061a801a1dcd6500121832d81e82030ad81e820b191388d8",
      "1e8201140500001910d6a1009f1a000302590001011a00060bc719026d00",
      "011a000249f01903e800011a000249f018201a0025cea81971f70419744d",
      "186419744d186419744d186419744d186419744d186419744d1864186418",
      "6419744d18641a000249f018201a000249f018201a000249f018201a0002",
      "49f01903e800011a000249f018201a000249f01903e800081a000242201a",
      "00067e2318760001011a000249f01903e800081a000249f01a0001b79818",
      "f7011a000249f0192710011a0002155e19052e011903e81a000249f01903",
      "e8011a000249f018201a000249f018201a000249f0182001011a000249f0",
      "011a000249f0041a000194af18f8011a000194af18f8011a0002377c1905",
      "56011a0002bdea1901f1011a000249f018201a000249f018201a000249f0",
      "18201a000249f018201a000249f018201a000249f018201a000242201a00",
      "067e23187600010119f04c192bd200011a000249f018201a000242201a00",
      "067e2318760001011a000242201a00067e2318760001011a0025cea81971",
      "f704001a000141bb041a000249f019138800011a000249f018201a000302",
      "590001011a000249f018201a000249f018201a000249f018201a000249f0",
      "18201a000249f018201a000249f018201a000249f018201a00330da70101",
      "ff82d81e82190241192710d81e821902d11a00989680821a00d59f801b00",
      "000002540be400821a03567e001b00000009502f90001913881896038100",
      "82a28200581c6b47a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315a",
      "b7ef058f1b00038d0a3a73f8008200581cd1f6f71a04ca856cc569fd068b",
      "069a555999c4776ad50b4cdd049d131b00038d0a3a73f800a0008483a282",
      "00581c6b47a4e6e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef05",
      "8f1b00038d0a3a73f8008200581cd1f6f71a04ca856cc569fd068b069a55",
      "5999c4776ad50b4cdd049d131b00038d0a3a73f800a28200581c6b47a4e6",
      "e19ac5257fc97bd220bd9ae368aa2d775d86315ab7ef058f581cd3e16257",
      "b8c608ec4b2cb89621d7ddb60fc08839c1b491a598615fb58200581cd1f6",
      "f71a04ca856cc569fd068b069a555999c4776ad50b4cdd049d13581c1dc0",
      "a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883fa2581c1d",
      "c0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f89581c",
      "1dc0a846ec816bdcc5288c0b57871a0400e86728ad0851132e43883f5820",
      "ee8fdadab21abed48fadee52492596841c561640920d1c022fa8ae51d206",
      "c7140000d81e820001581de022c700325ec932f59048a7258e89b5f16660",
      "4f184e0809d16a495550d901028080f6581cd3e16257b8c608ec4b2cb896",
      "21d7ddb60fc08839c1b491a598615fb589581cd3e16257b8c608ec4b2cb8",
      "9621d7ddb60fc08839c1b491a598615fb55820bbc57641002e501cf8bf98",
      "b776ba082c604e6af7c482f716934ed08d19c227330000d81e820001581d",
      "e03832f1051268ab7a7765142f21d695b7aaf40c576bf2d1a71894f0a4d9",
      "01028080f683a0a0a083a0a0a00082a0008082a2581c1dc0a846ec816bdc",
      "c5288c0b57871a0400e86728ad0851132e43883f83d81e8201021b00038d",
      "0a3a73f8005820ee8fdadab21abed48fadee52492596841c561640920d1c",
      "022fa8ae51d206c714581cd3e16257b8c608ec4b2cb89621d7ddb60fc088",
      "39c1b491a598615fb583d81e8201021b00038d0a3a73f8005820bbc57641",
      "002e501cf8bf98b776ba082c604e6af7c482f716934ed08d19c227331b00",
      "071a1474e7f000f6"
    ]
